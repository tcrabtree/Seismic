@using System.Text.Json
@model EventDetailViewModel
@{
    ViewData["Title"] = "Event Detail";
}

<h2 class="mb-4 border-bottom pb-2">Event @Model.EventId - Detail</h2>

<div class="row">
    <div class="col-lg-8">
        <partial name="_WaveformChart" model="Model" />
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-semibold bg-light">Event Classification</div>
            <div class="card-body">
                <div class="display-6 fw-semibold mb-2">@Model.ValidityScore.ToString("0")%</div>
                <div class="mb-3"><partial name="_StatusBadge" model="Model.Confidence" /></div>
                <div class="fw-semibold">Top 3 Contributing Factors</div>
                <ul class="mb-3">
                    @foreach (var factor in Model.ContributingFactors)
                    {
                        <li>@factor</li>
                    }
                </ul>
                <div><strong>Distance:</strong> @Model.DistanceMeters.ToString("0.0") m Â± @Model.DistanceErrorBandMeters.ToString("0.0") m</div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header fw-semibold bg-light">Feature Summary</div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><strong>Peak PPV (R/T/V):</strong> @Model.PeakPpvR / @Model.PeakPpvT / @Model.PeakPpvV</li>
                    <li><strong>RMS Energy:</strong> @Model.RmsEnergy</li>
                    <li><strong>Spectral Centroid:</strong> @Model.SpectralCentroid Hz</li>
                    <li><strong>Axis Correlation:</strong> @Model.AxisCorrelation</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header fw-semibold bg-light">Override Decision</div>
            <div class="card-body">
                <form id="overrideForm">
                    <div class="form-check"><input class="form-check-input" type="radio" name="decision" value="Valid" id="valid" checked><label class="form-check-label" for="valid">Valid</label></div>
                    <div class="form-check"><input class="form-check-input" type="radio" name="decision" value="False" id="false"><label class="form-check-label" for="false">False</label></div>
                    <div class="form-check mb-3"><input class="form-check-input" type="radio" name="decision" value="Needs Review" id="review"><label class="form-check-label" for="review">Needs Review</label></div>
                    <label class="form-label">Notes</label>
                    <textarea class="form-control mb-3" id="overrideNotes" rows="3"></textarea>
                    <button class="btn btn-primary" type="submit">Save Override</button>
                </form>
                <div id="overrideResult" class="small text-success mt-2"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
const eventId = @Model.EventId;
const seismic = @Html.Raw(JsonSerializer.Serialize(Model.SeismicWaveform));
const acoustic = @Html.Raw(JsonSerializer.Serialize(Model.AcousticWaveform));
const seismicOnset = @Model.SeismicOnsetIndex;
const acousticOnset = @Model.AcousticOnsetIndex;

const labels = Array.from({ length: seismic.length }, (_, i) => i);
const onsetDataset = {
    label: 'Onset Markers',
    type: 'scatter',
    data: [{ x: seismicOnset, y: seismic[seismicOnset] }, { x: acousticOnset, y: acoustic[acousticOnset] }],
    pointRadius: 5,
    pointBackgroundColor: ['#0d6efd', '#dc3545']
};

new Chart(document.getElementById('waveformChart'), {
    type: 'line',
    data: {
        labels,
        datasets: [
            { label: 'Seismic waveform', data: seismic, borderColor: '#0d6efd', pointRadius: 0, tension: 0.15 },
            { label: 'Acoustic waveform', data: acoustic, borderColor: '#dc3545', pointRadius: 0, tension: 0.15 },
            onsetDataset
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: { title: { display: true, text: 'Sample Index' } },
            y: { title: { display: true, text: 'Amplitude' } }
        }
    }
});

document.getElementById('overrideForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const decision = document.querySelector('input[name="decision"]:checked').value;
    const notes = document.getElementById('overrideNotes').value;
    const response = await fetch(`/api/events/${eventId}/override`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ decision, notes })
    });
    if (response.ok) {
        document.getElementById('overrideResult').innerText = 'Override saved.';
    }
});
</script>
}
