@model SiteEventsPageViewModel
@{
    ViewData["Title"] = "Events";
}

<div class="d-flex justify-content-between align-items-start mb-4 border-bottom pb-2">
    <h2 class="mb-0">@Model.SiteName - Event Review</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadEventCsvModal">
        Upload Event CSVs
    </button>
</div>

<div class="row">
    <partial name="_SummaryStatCard" model='("Total Events", Model.TotalEvents.ToString())' />
    <partial name="_SummaryStatCard" model='("Avg Validity Score", Model.AverageValidityScore.ToString("0.0"))' />
    <partial name="_SummaryStatCard" model='("# Low Confidence", Model.LowConfidenceCount.ToString())' />
    <partial name="_SummaryStatCard" model='("# Distance Deviations", Model.DistanceDeviationCount.ToString())' />
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold bg-light">Filters</div>
    <div class="card-body">
        <form method="get" asp-controller="Sites" asp-action="Events" asp-route-id="@Model.SiteId" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Confidence Level</label>
                <select class="form-select" name="confidence">
                    @foreach (var option in new[] { "All", "High", "Medium", "Low" })
                    {
                        <option value="@option" selected="@(option == Model.SelectedConfidence)">@option</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="flaggedOnly" value="true" id="flaggedOnly" checked="@Model.ShowOnlyFlagged" />
                    <label class="form-check-label" for="flaggedOnly">Show only flagged</label>
                </div>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary" type="submit">Apply Filter</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold bg-light">Event List</div>
    <div class="card-body p-0">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Monitor ID</th>
                    <th>Î”t (ms)</th>
                    <th>Estimated Distance (m)</th>
                    <th>Validity Score</th>
                    <th>Confidence</th>
                    <th>Flags</th>
                    <th class="text-end">Action</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var item in Model.Events)
            {
                <tr>
                    <td>@item.TimestampUtc.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>@item.MonitorId</td>
                    <td>@item.DeltaTMilliseconds.ToString("0.0")</td>
                    <td>@item.EstimatedDistanceMeters.ToString("0.0")</td>
                    <td>@item.ValidityScore.ToString("0.0")</td>
                    <td><partial name="_StatusBadge" model="item.Confidence" /></td>
                    <td>
                        @if (item.DistanceDeviationFlag)
                        {
                            <span class="badge bg-primary me-1">Distance Deviation</span>
                        }
                        @if (item.HealthWarningFlag)
                        {
                            <span class="badge bg-warning text-dark">Health Warning</span>
                        }
                    </td>
                    <td class="text-end">
                        <a class="btn btn-outline-secondary btn-sm" asp-controller="Events" asp-action="Details" asp-route-id="@item.Id">View</a>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<partial name="_UploadEventCsvModal" model="Model.SiteId" />

@section Scripts {
<script>
(function () {
    const fileInput = document.getElementById('uploadCsvFiles');
    const monitorInput = document.getElementById('uploadMonitorId');
    const eventDateInput = document.getElementById('uploadEventDate');
    const statusList = document.getElementById('uploadStatusList');
    const uploadBtn = document.getElementById('submitUploadCsvBtn');
    const progressBar = document.getElementById('uploadProgressBar');
    const alertHost = document.getElementById('uploadAlertHost');
    const siteId = document.getElementById('uploadSiteId').value;

    const setProgress = (value) => {
        const normalized = Math.max(0, Math.min(100, value));
        progressBar.style.width = `${normalized}%`;
        progressBar.textContent = `${Math.round(normalized)}%`;
    };

    const showAlert = (message, type) => {
        alertHost.innerHTML = `<div class="alert alert-${type} py-2" role="alert">${message}</div>`;
    };

    const clearAlert = () => {
        alertHost.innerHTML = '';
    };

    const appendStatus = (fileName, success, message) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span class="text-truncate me-2">${fileName}</span>
            <span>
                <span class="badge ${success ? 'bg-success' : 'bg-danger'} me-2">${success ? 'Success' : 'Failed'}</span>
                <small class="text-muted">${message ?? ''}</small>
            </span>`;
        statusList.appendChild(li);
    };

    uploadBtn.addEventListener('click', async () => {
        clearAlert();
        statusList.innerHTML = '';
        setProgress(0);

        const files = Array.from(fileInput.files ?? []);

        if (files.length === 0) {
            showAlert('No files selected.', 'warning');
            return;
        }

        const invalidFiles = files.filter(file => !file.name.toLowerCase().endsWith('.csv'));
        if (invalidFiles.length > 0) {
            showAlert(`Only .csv files are allowed. Invalid: ${invalidFiles.map(f => f.name).join(', ')}`, 'danger');
            return;
        }

        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        if (monitorInput.value.trim()) {
            formData.append('monitorId', monitorInput.value.trim());
        }

        if (eventDateInput.value) {
            formData.append('eventDate', eventDateInput.value);
        }

        uploadBtn.disabled = true;

        try {
            setProgress(30);
            const response = await fetch(`/api/events/upload-multiple?siteId=${encodeURIComponent(siteId)}`, {
                method: 'POST',
                body: formData
            });

            const results = await response.json();

            if (!Array.isArray(results)) {
                showAlert('Unexpected upload response.', 'danger');
                return;
            }

            let successCount = 0;
            results.forEach(result => {
                if (result.success) {
                    successCount++;
                }
                appendStatus(result.fileName || '(unknown)', result.success, result.error || (result.eventId ? `Event ID: ${result.eventId}` : ''));
            });

            setProgress(100);

            if (successCount > 0) {
                showAlert(`Uploaded ${successCount} of ${results.length} file(s). Refreshing event list...`, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('No files were uploaded successfully.', 'danger');
            }
        } catch {
            showAlert('Upload request failed. Try again.', 'danger');
        } finally {
            uploadBtn.disabled = false;
        }
    });
})();
</script>
}
